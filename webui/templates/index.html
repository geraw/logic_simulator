<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Logic Simulator Web UI</title>
  <link rel="stylesheet" href="{{ codemirror_css }}" />
  <script src="{{ codemirror_js }}"></script>
  <script src="{{ codemirror_mode }}"></script>
  <script src="{{ htmx_js }}"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; display: flex; height: 100vh; }
    aside { width: 210px; background:#222; color:#eee; padding:10px; overflow-y:auto; }
    main { flex:1; display:flex; flex-direction:column; }
    header { background:#333; color:#fff; padding:8px 12px; font-weight:bold; }
    #editor { flex:1; }
    textarea { width:100%; height:100%; }
    .panel { padding:8px; border-top:1px solid #ccc; background:#f7f7f7; }
    label { display:block; margin-top:6px; }
    pre { background:#111; color:#0f0; padding:8px; overflow:auto; }
    .outputs { font-family:monospace; }
    .challenge-item { cursor:pointer; padding:4px 6px; border-radius:4px; }
    .challenge-item.active { background:#555; }
    button { margin-right:4px; }
  </style>
</head>
<body>
  <aside>
    <h3>Challenges</h3>
    {% for c in challenges %}
      <div class="challenge-item {% if c==selected %}active{% endif %}" onclick="window.location='/?challenge={{c}}'">{{ c }}</div>
    {% endfor %}
  </aside>
  <main>
    <header>Editing: {{ selected or 'None' }}</header>
    <div id="editor">
      <textarea id="code" name="code">{{ code|e }}</textarea>
    </div>
    <div class="panel">
      <form id="simform" hx-post="/simulate" hx-target="#simresult" hx-trigger="submit" hx-indicator="#simloading">
        <label>Inputs (e.g. X=1010;Y=111): <input type="text" name="inputs" style="width:320px"/></label>
        <label>Steps: <input type="number" name="steps" value="8" min="1" max="128"/></label>
        <input type="hidden" name="code" id="hidden_code" />
        <button type="submit">Simulate</button>
        <button type="button" onclick="score()">Score</button>
        <span id="simloading" style="display:none">Running...</span>
      </form>
      <div id="simresult" class="outputs"></div>
      <div id="scoreresult" class="outputs"></div>
    </div>
  </main>

  <script>
    const ta = document.getElementById('code');
    const editor = CodeMirror.fromTextArea(ta, { lineNumbers:true, mode:'text/plain', theme:'default' });
    function refreshHidden(){
      document.getElementById('hidden_code').value = editor.getValue();
    }
    setInterval(refreshHidden, 400);

    function renderOutputs(resp){
      if(resp.error){
        return `<div style='color:red'>Error: ${resp.error}<pre>${resp.trace||''}</pre></div>`;
      }
      let out = [];
      if(resp.outputs){
        out.push('<h4>Outputs</h4>');
        for(const [k,v] of Object.entries(resp.outputs)){
          out.push(`<div>${k}: <code>${v}</code></div>`);
        }
      }
      return out.join('\n');
    }

    document.getElementById('simform').addEventListener('submit', function(){
      refreshHidden();
    });

    async function score(){
      refreshHidden();
      const formData = new FormData();
      formData.append('code', editor.getValue());
      formData.append('challenge', '{{selected}}');
      const r = await fetch('/score', { method:'POST', body: formData });
      const resp = await r.json();
      if(resp.error){
        document.getElementById('scoreresult').innerHTML = `<div style='color:red'>${resp.error}</div>`;
      } else {
        document.getElementById('scoreresult').innerHTML = resp.passed ? '<div style="color:green">All tests passed ✔</div>' : '<div style="color:orange">Tests failed ✖</div>';
      }
    }
  </script>
</body>
</html>