<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Logic Simulator (Pyodide)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/mode/simple.min.js"></script>
  <script src="circuit_mode.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; height:100vh; display:flex; flex-direction:column; }
    header { background:#222; color:#fff; padding:8px 14px; font-weight:600; }
    #menu { background:#eee; border-bottom:1px solid #ccc; padding:6px 14px; display:flex; gap:18px; align-items:center; }
    #menu select { margin-left:8px; }
    main { flex:1; display:grid; grid-template-columns: 1fr; gap:8px; padding:8px; }
    #editor { height:100%; }
    .panel { background:#f5f5f5; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px; }
    textarea { width:100%; height:160px; }
    pre { background:#111; color:#0f0; padding:8px; overflow:auto; font-size:13px; }
    button { cursor:pointer; }
    #status { font-size:12px; color:#555; }
    select { width:100%; }
    .modal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:#fff; border-radius:8px; box-shadow:0 2px 16px #0003; padding:24px; min-width:320px; max-width:80vw; max-height:80vh; overflow:auto; position:relative; }
    .modal-close { position:absolute; top:8px; right:12px; font-size:18px; background:none; border:none; cursor:pointer; color:#333; }
  </style>
</head>
<body>
<header>Logic Simulator - Type in your circuit code and simulate</header>
<div id="menu">
  <button id="runBtn">Simulate</button>
  <span>Challenge:
    <select id="challengeSelect"></select>
  </span>
  <button id="scoreMenuBtn">Score Challenge</button>
  <button id="logMenuBtn">Show Log</button>
  <span id="status"></span>
</div>
<main>
  <textarea id="code"># Loading sample circuit...
NOT(x) := NAND(x,x)
A = NOT(B)
</textarea>
  <div class="panel">
    <label>Inputs (X=101;Y=11): <input id="inputs" style="width:260px" value="B=101010" /></label>
    <label>Steps: <input id="steps" type="number" value="8" min="1" max="256" /></label>
  </div>
  <div class="panel">
    <h3>Outputs</h3>
    <div id="outputs"></div>
  </div>
  <!-- Error Modal -->
  <div id="errorModal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close" onclick="document.getElementById('errorModal').style.display='none'">&times;</button>
      <!-- <h4>Error</h4> -->
      <div id="errormsg"></div>
    </div>
  </div>
</main>
<!-- Modal containers -->
<div id="logModal" class="modal" style="display:none;">
  <div class="modal-content">
    <button class="modal-close" onclick="document.getElementById('logModal').style.display='none'">&times;</button>
    <h3>Log</h3>
    <pre id="log"></pre>
  </div>
</div>
<div id="scoreModal" class="modal" style="display:none;">
  <div class="modal-content">
    <button class="modal-close" onclick="document.getElementById('scoreModal').style.display='none'">&times;</button>
    <h3>Score Result</h3>
    <div id="scoreresult"></div>
  </div>
</div>
<script>
  let editor = CodeMirror.fromTextArea(document.getElementById('code'), { lineNumbers:true, mode:'circuitdsl', gutters: ["CodeMirror-linenumbers", "syntax-errors"] });
  const statusEl = document.getElementById('status');
  const logEl = document.getElementById('log');
  const challengeSelect = document.getElementById('challengeSelect');
  const logModal = document.getElementById('logModal');
  const scoreModal = document.getElementById('scoreModal');

  function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

  // Log modal logic
  document.getElementById('logMenuBtn').addEventListener('click', function(){
    logModal.style.display = 'flex';
  });

  async function loadChallenges(){
    try {
      const r = await fetch('challenges_index.json');
      const data = await r.json();
      data.challenges.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; challengeSelect.appendChild(opt);
      });
    } catch(e){ log('No challenge index found.'); }
  }

  let pyodideReadyPromise = (async () => {
    statusEl.textContent = 'Loading Pyodide...';
    const pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/' });
    statusEl.textContent = 'Installing lark via micropip...';
    await pyodide.loadPackage('micropip');
    await pyodide.runPythonAsync(`import micropip; await micropip.install('lark-parser')`);
    statusEl.textContent = 'Fetching project sources...';

    async function fetchText(path){
      const r = await fetch(path); if(!r.ok) throw new Error('fetch failed '+path); return await r.text(); }
    // We are in webui/static/ ; project root is two levels up (../..)
    const rootPrefix = '../../';
    const files = ['circuit_parser.py','simulator.py','grammar.lark','scoring_framework.py'];
    for (const f of files){
      let ok = false;
      for (const prefix of [rootPrefix, '../'+f]) { // try root then (legacy) wrong path for diagnostics
        try {
          const path = prefix === rootPrefix ? rootPrefix+f : '../'+f; // clarity
          const txt = await fetchText(path);
          pyodide.FS.writeFile(f, txt);
          log('Loaded '+f+' from '+path);
          ok = true; break;
        } catch(e) {
          // continue to next attempt
        }
      }
      if(!ok) log('FAILED to load '+f+' (adjust paths if hosting structure differs)');
    }

  // Provide a lightweight wrapper for simulate in Python
  await pyodide.runPythonAsync(`
import json
from circuit_parser import parse_file
from simulator import Simulator

def simulate_inline(code:str, inputs:dict, steps:int):
  with open('_inline.cir','w') as f:
    f.write(code)
  circuit = parse_file('_inline.cir')
  sim = Simulator(circuit)
  outputs = sim.run(inputs, steps)
  result = {'outputs': outputs, 'history': sim.history}
  return json.dumps(result)
`);

    return pyodide;
  })();

  async function checkSyntaxLive(code) {
    const pyodide = await pyodideReadyPromise;
    // Remove previous error highlights and gutter markers
    if(window._errMarker){ window._errMarker.clear(); window._errMarker = null; }
    editor.clearGutter("syntax-errors");
    try {
      // Try parsing only, don't run simulation
      await pyodide.runPythonAsync(`from circuit_parser import parse_file\nparse_file('_inline.cir')`, { globals: { '__builtins__': pyodide.globals.get('__builtins__'), 'open': () => ({ write: () => code }) } });
      // No error, do nothing
    } catch(e) {
      let fullMsg = (e && e.message) ? String(e.message) : String(e);
      // Extract line/col info
      let lineColMatch = fullMsg.match(/at line (\d+) col (\d+)/);
      let lineNum = null, colNum = null;
      if(lineColMatch){
        lineNum = parseInt(lineColMatch[1],10);
        colNum = parseInt(lineColMatch[2],10);
      }
      // Highlight error line and gutter
      if(lineNum){
        window._errMarker = editor.markText({line:lineNum-1,ch:colNum?colNum-1:0},{line:lineNum-1,ch:colNum?colNum:100},{className:'cm-error-highlight'});
        const marker = document.createElement("div");
        marker.style.color = "#b00";
        marker.innerHTML = "&#x25CF;";
        marker.title = "Syntax error";
        editor.setGutterMarker(lineNum-1, "syntax-errors", marker);
      }
    }
  }

  editor.on('change', function(){
    checkSyntaxLive(editor.getValue());
  });

  async function simulate(){
    const pyodide = await pyodideReadyPromise;
    statusEl.textContent = 'Simulating...';
    const code = editor.getValue();
    const steps = parseInt(document.getElementById('steps').value,10) || 8;
    const inputStr = document.getElementById('inputs').value.trim();
    const inputs = {};
    if(inputStr){
      for(const frag of inputStr.split(';')){
        if(!frag) continue; const [k,v] = frag.split('='); if(k && v) inputs[k.trim()] = v.trim().replace(/[^01]/g,'');
      }
    }
    try {
      document.getElementById('errorModal').style.display = 'none';
      document.getElementById('errormsg').innerHTML = '';
      const pySnippet = `res = simulate_inline(${JSON.stringify(code)}, ${JSON.stringify(inputs)}, ${steps})`;
      log('Running simulation with inputs: '+JSON.stringify(inputs)+', steps: '+steps);
      await pyodide.runPythonAsync(pySnippet);
      log('Simulation completed');
      if(!pyodide.runPython("'res' in globals()")) throw new Error('No result returned');
      const pyResult = pyodide.runPython('res');
      log('Raw result: '+pyResult);
      if(!pyResult) throw new Error('Result object is null');
      let jsResult;
      try { jsResult = JSON.parse(pyResult); } catch(_){ throw new Error('Failed to parse simulation result as JSON'); }
      log('Converted result: '+JSON.stringify(jsResult));
      if(!jsResult || typeof jsResult !== 'object') throw new Error('Result not an object');
      let outputsObj = jsResult.outputs;
      if(!outputsObj){
        log('Debug jsResult keys: '+Object.keys(jsResult));
        throw new Error('Missing outputs in result');
      }
      const outDiv = document.getElementById('outputs');
      outDiv.innerHTML = '';
      Object.entries(outputsObj).forEach(([k,v]) => {
        const d = document.createElement('div'); d.textContent = k+': '+v; outDiv.appendChild(d);
      });
      statusEl.textContent = 'Done';
    } catch(e){
      let fullMsg = (e && e.message) ? String(e.message) : String(e);
      // If RuntimeError, ValueError, or MacroCycleError, extract its text
      let errorText = '';
      if (fullMsg.includes('RuntimeError:')) {
        errorText = fullMsg.split('RuntimeError:')[1].trim();
        let syntaxBlock = errorText.match(/---[^\n]+---[\s\S]*?(?=\n\s*Details:|$)/);
        if(syntaxBlock){
          errorText = syntaxBlock[0];
        }
        let detailsMatch = fullMsg.match(/Details:[\s\S]*$/);
        if(detailsMatch){
          errorText += '\n' + detailsMatch[0];
        }
      } else if (fullMsg.includes('ValueError:')) {
        errorText = fullMsg.split('ValueError:')[1].trim();
      } else if (fullMsg.includes('MacroCycleError:')) {
        errorText = fullMsg.split('MacroCycleError:')[1].trim();
      } else {
        let lines = fullMsg.split('\n');
        let filtered = lines.filter(l => !l.includes('Traceback') && !l.match(/File "/) && !l.match(/eval_code_async/) && !l.match(/run_async/) && !l.match(/CodeRunner/) && !l.match(/<exec>/));
        errorText = filtered.join('\n').trim();
        if(!errorText) errorText = fullMsg;
      }
      // HTML escape, but preserve leading spaces for alignment
      errorText = errorText.replace(/</g,'&lt;').replace(/>/g,'&gt;');
      // Replace each line's leading spaces with &nbsp; for correct arrow alignment
      errorText = errorText.split('\n').map(l => l.replace(/^ +/g, m => '&nbsp;'.repeat(m.length))).join('<br>');
      let html = `<div style='margin-bottom:8px; color:#b00; font-family:monospace; white-space:pre;'>${errorText}</div>`;
      document.getElementById('errormsg').innerHTML = html;
      document.getElementById('errorModal').style.display = 'flex';
      log('Error: '+fullMsg);
      statusEl.textContent = 'Error';
      // Remove previous gutter marker
      editor.clearGutter("syntax-errors");
      // Highlight error line in editor and add gutter marker for syntax errors
      let lineColMatch = fullMsg.match(/at line (\d+) col (\d+)/);
      let lineNum = null, colNum = null;
      if(lineColMatch){
        lineNum = parseInt(lineColMatch[1],10);
        colNum = parseInt(lineColMatch[2],10);
        window._errMarker = editor.markText({line:lineNum-1,ch:colNum?colNum-1:0},{line:lineNum-1,ch:colNum?colNum:100},{className:'cm-error-highlight'});
        if(fullMsg.includes('Syntax Error') || fullMsg.includes('UnexpectedCharacters')){
          const marker = document.createElement("div");
          marker.style.color = "#b00";
          marker.innerHTML = "&#x25CF;";
          marker.title = "Syntax error";
          editor.setGutterMarker(lineNum-1, "syntax-errors", marker);
        }
        editor.scrollIntoView({line:lineNum-1, ch:0}, 100);
      }
    }
  // Add error highlight style
  const style = document.createElement('style');
  style.innerHTML = `.cm-error-highlight { background: #ffb8b8; border-bottom: 2px solid #b00; }`;
  document.head.appendChild(style);
  }

  async function scoreChallenge(){
    const challenge = challengeSelect.value;
    if(!challenge){ log('No challenge selected'); return; }
    const pyodide = await pyodideReadyPromise;
    statusEl.textContent = 'Scoring...';
    try {
      // Fetch score.py
      const scorePath = '../../challenges/'+challenge+'/score.py';
      const r = await fetch(scorePath); if(!r.ok) throw new Error('Cannot fetch '+scorePath);
      const scoreCode = await r.text();
      pyodide.FS.writeFile('score_tmp.py', scoreCode);
      // Write circuit submission
      const code = editor.getValue();
      pyodide.FS.writeFile('_web_submission.cir', code);

      const py = `import importlib.util, sys\n`+
        `spec = importlib.util.spec_from_file_location('score_tmp','score_tmp.py')\n`+
        `mod = importlib.util.module_from_spec(spec)\n`+
        `sys.modules['score_tmp'] = mod\n`+
        `spec.loader.exec_module(mod)\n`+
        `import json\n`+
        `result = {'passed': False, 'error': 'verify_circuit() missing'}\n`+
        `if hasattr(mod, 'verify_circuit'):\n`+
        `    ok = mod.verify_circuit('_web_submission.cir')\n`+
        `    result = {'passed': ok}\n`+
        `result`;
      const pyRes = await pyodide.runPythonAsync(py);
      let jsRes;
      try { jsRes = pyRes.toJs(); } catch(_){ jsRes = pyRes; }
      let passedVal = (jsRes && (jsRes.passed !== undefined ? jsRes.passed : (jsRes.get ? jsRes.get('passed') : undefined)));
      if(passedVal === undefined){
        document.getElementById('scoreresult').innerHTML = '<span style="color:red">Malformed scoring result</span>';
        log('Score debug keys: '+ (jsRes ? Object.keys(jsRes) : 'none'));
      } else {
        document.getElementById('scoreresult').innerHTML = passedVal ? '<span style="color:green">All tests passed ✔</span>' : '<span style="color:orange">Tests failed ✖</span>';
      }
      scoreModal.style.display = 'flex';
      statusEl.textContent = 'Score complete';
    } catch(e){
      log('Score error: '+e);
      statusEl.textContent = 'Score error';
    }
  }

  document.getElementById('runBtn').addEventListener('click', simulate);
  document.getElementById('scoreMenuBtn').addEventListener('click', scoreChallenge);
  loadChallenges();
</script>
</body>
</html>